#!/bin/bash -exu
authenticate_om() {
  export OM_TARGET="https://$(terraform output ops_manager_dns)"
  export OM_PASSWORD="$1"
  export OM_USERNAME="$2"
}

main() {
  local path=${1?"Path is required (e.g. terraforming-pas, terraforming-control-plane)"}
  local password=${2?"OpsManager password is required."}
  local username=${3?"OpsManager username is required."}

  pushd "$PROJECT_DIR/${path}" > /dev/null
    RAW_JSON=$(jq -e --raw-output '.modules[0].outputs | map_values(.value)' terraform.tfstate)
    WITH_CERT=$(echo "${RAW_JSON}" | jq --arg terraformingca "${CA_CERT}" '. + {terraforming_ca_cert: $terraformingca}')

    authenticate_om "${password}" ${username}

    om -k configure-authentication -dp "${OM_PASSWORD}"
    om -k configure-director --config <(texplate execute "$PROJECT_DIR/ci/assets/template/director-config.yml" -f  <(echo "${RAW_JSON}") -o yaml)
  popd > /dev/null
}

main "$@"
